name: Deploy Supabase DB Migrations

on:
  push:
    branches: ["main"]
    paths:
      - "supabase/migrations/**"
      - "supabase/config.toml"
      - ".github/workflows/supabase-db-deploy.yaml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Login to Supabase
        run: supabase login --token "${{ secrets.SUPABASE_ACCESS_TOKEN }}"

      - name: Link project
        run: supabase link --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}"
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      
      - name: Debug - show working dir and migrations
        run: |
          pwd
          ls -la
          find . -maxdepth 3 -type f -name "config.toml" -o -path "*supabase/migrations/*" | head -n 200
          ls -la supabase || true
          ls -la supabase/migrations || true

      - name: Push migrations to remote
        run: supabase db push
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}